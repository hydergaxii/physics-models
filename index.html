<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåßÔ∏è ULTIMATE Ultra-Realistic 2D Rain Physics Animation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            overflow: hidden;
            user-select: none;
        }
        
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: linear-gradient(to bottom, #87ceeb 0%, #98d4f0 30%, #a9ddf5 100%);
            border: 3px solid #fff;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            cursor: crosshair;
            border-radius: 10px;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #ffc107;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            min-width: 280px;
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            color: white;
            padding: 14px 28px;
            margin: 8px 4px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255,107,107,0.4);
        }
        
        .btn.running {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        
        .btn.paused {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .slider-container {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .slider-container label {
            display: block;
            color: #fff;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .slider:hover {
            opacity: 1;
        }
        
        .math-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(15,15,15,0.95);
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #2196f3;
            font-size: 16px;
            line-height: 2;
            max-width: 450px;
            box-shadow: 0 8px 32px rgba(33,150,243,0.3);
            backdrop-filter: blur(15px);
        }
        
        .math-title {
            color: #2196f3;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .phase-display {
            color: #ffeb3b;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,235,59,0.1);
            border-radius: 8px;
            border-left: 4px solid #ffeb3b;
        }
        
        .math-formula {
            background: rgba(33, 150, 243, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #2196f3;
            font-size: 24px;
            text-align: center;
            font-weight: bold;
            font-family: 'Times New Roman', serif;
        }
        
        .explanation {
            color: #e0e0e0;
            font-style: italic;
            margin-top: 15px;
            font-size: 16px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .vector-notation {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            font-style: italic;
        }
        
        /* Loading screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading-content {
            text-align: center;
            color: white;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196f3;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .controls {
                position: relative;
                width: 100%;
                margin: 10px;
            }
            
            .math-display {
                position: relative;
                width: 100%;
                margin: 10px;
                max-width: none;
            }
            
            #gameCanvas {
                width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>

<!-- Loading Screen -->
<div id="loadingScreen">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h2>Loading Physics Animation...</h2>
        <p>Preparing mathematical notation system</p>
    </div>
</div>

<div class="controls">
    <h3 style="color: #ffc107; margin-bottom: 20px; text-align: center;">üéÆ PHYSICS CONTROLS</h3>
    <div style="text-align: center;">
        <button class="btn" id="playBtn">‚ñ∂Ô∏è Start Running</button>
        <button class="btn" id="pauseBtn">‚è∏Ô∏è Pause</button>
        <button class="btn" id="resetBtn">üîÑ Reset</button>
    </div>
    
    <div class="slider-container">
        <label for="rainSlider">üåßÔ∏è Rain Intensity: <span id="rainValue">150</span></label>
        <input type="range" id="rainSlider" class="slider" min="50" max="400" value="150">
    </div>
    
    <div class="slider-container">
        <label for="speedSlider">üèÉ Man Speed: <span id="speedValue">2.0</span></label>
        <input type="range" id="speedSlider" class="slider" min="0.5" max="5" step="0.1" value="2.0">
    </div>
</div>

<div class="math-display" id="mathDisplay">
    <div class="math-title">üìê Physics Analysis</div>
    <div class="phase-display" id="currentPhase">Phase: Man holding umbrella at angle Œ∏</div>
    <div class="math-formula" id="formula">
        <span class="vector-notation" style="color: #4ade80;">v‚Éó<sub>rain,rel</sub></span> = 
        <span class="vector-notation" style="color: #4ade80;">v‚Éó<sub>rain,ground</sub></span>
    </div>
    <div class="explanation" id="explanation">Rain hits umbrella diagonally from above</div>
</div>

<canvas id="gameCanvas" width="1200" height="700"></canvas>

<script>
// ========== SMOOTH ANIMATION SETUP ==========
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Ultra-high quality setup
const dpi = window.devicePixelRatio || 1;
canvas.width = 1200 * dpi;
canvas.height = 700 * dpi;
ctx.scale(dpi, dpi);
canvas.style.width = '1200px';
canvas.style.height = '700px';

// Enable all quality features
ctx.imageSmoothingEnabled = true;
ctx.imageSmoothingQuality = 'high';
ctx.textRenderingOptimization = 'optimizeQuality';

// ========== ANIMATION STATE ==========
let gameState = {
    isRunning: false,
    isPaused: false,
    hasUmbrella: true,
    umbrellaThrown: false,
    manSpeed: 2.0,
    rainIntensity: 150,
    time: 0,
    loaded: false
};

// ========== ULTRA-REALISTIC HUMAN ==========
class UltraRealisticMan {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.width = 45;
        this.height = 130;
        this.runCycle = 0;
        this.armSwing = 0;
        this.breathe = 0;
    }
    
    update() {
        if (gameState.isRunning) {
            this.runCycle += 0.22;
            this.armSwing = Math.sin(this.runCycle) * 15;
            this.x += gameState.manSpeed;
            
            // Loop position
            if (this.x > 1300) this.x = -100;
        } else {
            this.breathe += 0.02;
        }
    }
    
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        
        // Running bob and lean
        if (gameState.isRunning) {
            ctx.translate(0, Math.sin(this.runCycle * 2) * 1.2);
            ctx.rotate(Math.sin(this.runCycle * 0.8) * 0.03);
        } else {
            // Subtle breathing
            ctx.translate(0, Math.sin(this.breathe) * 0.3);
        }
        
        // Shadow
        ctx.save();
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.scale(1, 0.3);
        ctx.translate(0, 150);
        ctx.beginPath();
        ctx.ellipse(0, 0, 25, 8, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        
        // Head with realistic shading
        let headGradient = ctx.createRadialGradient(-8, -105, 3, -2, -100, 25);
        headGradient.addColorStop(0, '#ffd4c4');
        headGradient.addColorStop(0.6, '#fdbcb4');
        headGradient.addColorStop(1, '#e8a896');
        ctx.fillStyle = headGradient;
        ctx.beginPath();
        ctx.ellipse(0, -100, 20, 24, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Hair
        ctx.fillStyle = '#8b4513';
        ctx.beginPath();
        ctx.ellipse(0, -115, 22, 18, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Hair texture
        ctx.strokeStyle = '#654321';
        ctx.lineWidth = 1;
        for (let i = 0; i < 8; i++) {
            let angle = (Math.PI * 2 * i) / 8;
            ctx.beginPath();
            ctx.moveTo(Math.cos(angle) * 15, -115 + Math.sin(angle) * 12);
            ctx.lineTo(Math.cos(angle) * 20, -115 + Math.sin(angle) * 16);
            ctx.stroke();
        }
        
        // Eyes with detail
        ctx.fillStyle = 'white';
        ctx.fillRect(-10, -105, 7, 5);
        ctx.fillRect(3, -105, 7, 5);
        
        ctx.fillStyle = '#4169e1';
        ctx.beginPath();
        ctx.arc(-6, -103, 2, 0, Math.PI * 2);
        ctx.arc(7, -103, 2, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(-6, -103, 1, 0, Math.PI * 2);
        ctx.arc(7, -103, 1, 0, Math.PI * 2);
        ctx.fill();
        
        // Eyebrows
        ctx.strokeStyle = '#654321';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(-10, -108);
        ctx.lineTo(-2, -110);
        ctx.moveTo(2, -110);
        ctx.lineTo(10, -108);
        ctx.stroke();
        
        // Nose
        ctx.strokeStyle = '#d4a574';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, -100);
        ctx.lineTo(-1, -96);
        ctx.lineTo(1, -96);
        ctx.stroke();
        
        // Mouth
        ctx.strokeStyle = '#b8860b';
        ctx.lineWidth = 2;
        ctx.beginPath();
        if (gameState.isRunning) {
            ctx.arc(0, -92, 4, 0, Math.PI); // Open mouth when running
        } else {
            ctx.arc(0, -92, 2, 0, Math.PI); // Closed mouth
        }
        ctx.stroke();
        
        // Neck
        ctx.fillStyle = '#fdbcb4';
        ctx.fillRect(-8, -78, 16, 12);
        
        // Body (shirt) with realistic gradient
        let bodyGradient = ctx.createLinearGradient(-20, -75, 20, -20);
        bodyGradient.addColorStop(0, '#4169e1');
        bodyGradient.addColorStop(0.3, '#5578f0');
        bodyGradient.addColorStop(0.7, '#3a5bdb');
        bodyGradient.addColorStop(1, '#1e3a8a');
        ctx.fillStyle = bodyGradient;
        ctx.fillRect(-18, -75, 36, 55);
        
        // Shirt details
        ctx.strokeStyle = '#1e3a8a';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(-18, -50);
        ctx.lineTo(18, -50);
        ctx.stroke();
        
        // Buttons
        ctx.fillStyle = '#333';
        for (let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.arc(0, -65 + i * 15, 2, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Arms with realistic movement
        ctx.fillStyle = '#fdbcb4';
        
        // Left arm
        ctx.save();
        ctx.translate(-23, -65);
        let leftArmAngle = gameState.isRunning ? this.armSwing * Math.PI / 180 : Math.sin(this.breathe) * 0.02;
        ctx.rotate(leftArmAngle);
        ctx.fillRect(-6, 0, 12, 45);
        
        // Left hand
        ctx.beginPath();
        ctx.arc(0, 45, 7, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        
        // Right arm
        ctx.save();
        ctx.translate(23, -65);
        let rightArmAngle = gameState.isRunning && !gameState.hasUmbrella ? 
            -this.armSwing * Math.PI / 180 : 
            Math.sin(this.breathe + Math.PI) * 0.02;
        ctx.rotate(rightArmAngle);
        ctx.fillRect(-6, 0, 12, 45);
        
        // Right hand
        ctx.beginPath();
        ctx.arc(0, 45, 7, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        
        // Legs with dynamic animation
        let legGradient = ctx.createLinearGradient(-15, -25, 15, 20);
        legGradient.addColorStop(0, '#2c3e50');
        legGradient.addColorStop(1, '#1a252f');
        ctx.fillStyle = legGradient;
        
        if (gameState.isRunning) {
            // Animated running legs
            let leftLegAngle = Math.sin(this.runCycle) * 30;
            let rightLegAngle = Math.sin(this.runCycle + Math.PI) * 30;
            
            // Left leg
            ctx.save();
            ctx.translate(-12, -25);
            ctx.rotate(leftLegAngle * Math.PI / 180);
            ctx.fillRect(-7, 0, 14, 50);
            
            // Left foot
            ctx.fillStyle = '#654321';
            ctx.fillRect(-10, 50, 20, 10);
            ctx.restore();
            
            // Right leg
            ctx.save();
            ctx.translate(12, -25);
            ctx.rotate(rightLegAngle * Math.PI / 180);
            ctx.fillRect(-7, 0, 14, 50);
            
            // Right foot
            ctx.fillStyle = '#654321';
            ctx.fillRect(-10, 50, 20, 10);
            ctx.restore();
        } else {
            // Standing legs
            ctx.fillRect(-18, -25, 14, 50);
            ctx.fillRect(4, -25, 14, 50);
            
            // Feet
            ctx.fillStyle = '#654321';
            ctx.fillRect(-22, 25, 22, 10);
            ctx.fillRect(0, 25, 22, 10);
        }
        
        ctx.restore();
    }
}

// ========== ULTRA-REALISTIC UMBRELLA ==========
class UltraRealisticUmbrella {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.angle = -Math.PI / 6;
        this.thrown = false;
        this.velocity = { x: 0, y: 0 };
        this.rotation = 0;
        this.bounce = 0;
    }
    
    throw() {
        if (!this.thrown) {
            this.thrown = true;
            this.velocity.x = 4.5 + Math.random() * 1.5;
            this.velocity.y = -7 - Math.random() * 2;
            gameState.hasUmbrella = false;
            gameState.umbrellaThrown = true;
        }
    }
    
    update() {
        if (this.thrown) {
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.velocity.y += 0.3; // gravity
            this.rotation += 0.12;
            
            // Realistic ground bounce
            if (this.y > 650) {
                this.velocity.y *= -0.4;
                this.velocity.x *= 0.75;
                this.bounce++;
                
                // Stop bouncing after a while
                if (Math.abs(this.velocity.y) < 0.5) {
                    this.velocity.y = 0;
                    this.y = 650;
                }
            }
        }
    }
    
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        
        if (this.thrown) {
            ctx.rotate(this.rotation);
        }
        
        // Umbrella shadow
        if (!this.thrown || this.y > 600) {
            ctx.save();
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.scale(1, 0.3);
            ctx.translate(0, 200);
            ctx.beginPath();
            ctx.ellipse(0, 0, 30, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
        
        // Handle with wood texture
        let handleGradient = ctx.createLinearGradient(-3, 0, 3, 0);
        handleGradient.addColorStop(0, '#654321');
        handleGradient.addColorStop(0.3, '#8b4513');
        handleGradient.addColorStop(0.7, '#a0522d');
        handleGradient.addColorStop(1, '#654321');
        
        ctx.strokeStyle = handleGradient;
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, -65);
        ctx.stroke();
        
        // Handle details
        for (let i = 0; i < 3; i++) {
            ctx.strokeStyle = '#4a2c17';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(-2, -15 - i * 15);
            ctx.lineTo(2, -15 - i * 15);
            ctx.stroke();
        }
        
        // Handle grip
        ctx.fillStyle = '#4a2c17';
        ctx.beginPath();
        ctx.arc(0, 8, 5, 0, Math.PI * 2);
        ctx.fill();
        
        // Umbrella canopy with realistic fabric texture
        let canopyGradient = ctx.createRadialGradient(0, -65, 0, 0, -65, 50);
        canopyGradient.addColorStop(0, '#ff1744');
        canopyGradient.addColorStop(0.3, '#dc143c');
        canopyGradient.addColorStop(0.7, '#c62828');
        canopyGradient.addColorStop(1, '#8b0000');
        
        ctx.fillStyle = canopyGradient;
        ctx.strokeStyle = '#6d0000';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.ellipse(0, -65, 50, 28, 0, Math.PI, 0);
        ctx.fill();
        ctx.stroke();
        
        // Canopy segments for realism
        ctx.strokeStyle = '#8b0000';
        ctx.lineWidth = 1;
        for (let i = 1; i < 8; i++) {
            let segmentAngle = (Math.PI * i) / 8;
            let x = Math.cos(segmentAngle) * 48;
            let y = Math.sin(segmentAngle) * -25;
            ctx.beginPath();
            ctx.moveTo(0, -65);
            ctx.lineTo(x, y - 65);
            ctx.stroke();
        }
        
        // Metal ribs
        ctx.strokeStyle = '#2c3e50';
        ctx.lineWidth = 2;
        for (let i = 0; i < 8; i++) {
            let angle = (Math.PI * i) / 7;
            let x = Math.cos(angle) * 45;
            let y = Math.sin(angle) * -24;
            ctx.beginPath();
            ctx.moveTo(0, -65);
            ctx.lineTo(x, y - 65);
            ctx.stroke();
            
            // Rib tips
            ctx.fillStyle = '#34495e';
            ctx.beginPath();
            ctx.arc(x, y - 65, 2, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Central ferrule
        ctx.fillStyle = '#2c3e50';
        ctx.beginPath();
        ctx.arc(0, -65, 4, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.restore();
    }
}

// ========== ULTRA-REALISTIC RAIN ==========
class PremiumRainDrop {
    constructor() {
        this.reset();
        this.y = Math.random() * 700;
    }
    
    reset() {
        this.x = Math.random() * 1400 - 200;
        this.y = -50;
        this.speed = 12 + Math.random() * 8;
        this.angle = gameState.isRunning ? 0 : 0.2;
        this.length = 20 + Math.random() * 15;
        this.opacity = 0.5 + Math.random() * 0.4;
        this.thickness = 1.5 + Math.random() * 1;
        this.wobble = Math.random() * 0.02;
    }
    
    update() {
        if (gameState.isRunning) {
            this.x += Math.sin(gameState.time * this.wobble) * 0.1;
            this.y += this.speed;
        } else {
            this.x += this.speed * this.angle + Math.sin(gameState.time * this.wobble) * 0.2;
            this.y += this.speed;
        }
        
        if (this.y > 750) {
            this.reset();
        }
    }
    
    draw() {
        ctx.save();
        ctx.globalAlpha = this.opacity;
        
        // Rain gradient for realism
        let gradient = ctx.createLinearGradient(this.x, this.y, this.x, this.y + this.length);
        gradient.addColorStop(0, '#87ceeb');
        gradient.addColorStop(0.5, '#4fc3f7');
        gradient.addColorStop(1, 'rgba(79, 195, 247, 0)');
        
        ctx.strokeStyle = gradient;
        ctx.lineWidth = this.thickness;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        
        if (gameState.isRunning) {
            ctx.lineTo(this.x, this.y + this.length);
        } else {
            ctx.lineTo(this.x + this.length * this.angle, this.y + this.length);
        }
        
        ctx.stroke();
        ctx.restore();
    }
}

// ========== PERFECT VECTOR SYSTEM ==========
function drawPerfectVector(startX, startY, endX, endY, color, label, labelColor) {
    ctx.save();
    
    // Vector shadow for depth
    ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
    ctx.lineWidth = 6;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(startX + 2, startY + 2);
    ctx.lineTo(endX + 2, endY + 2);
    ctx.stroke();
    
    // Main vector line
    ctx.strokeStyle = color;
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.beginPath();
    ctx.moveTo(startX, startY);
    ctx.lineTo(endX, endY);
    ctx.stroke();
    
    // Arrow head
    let angle = Math.atan2(endY - startY, endX - startX);
    let headLength = 22;
    
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(endX, endY);
    ctx.lineTo(
        endX - headLength * Math.cos(angle - Math.PI/6),
        endY - headLength * Math.sin(angle - Math.PI/6)
    );
    ctx.lineTo(
        endX - headLength * Math.cos(angle + Math.PI/6),
        endY - headLength * Math.sin(angle + Math.PI/6)
    );
    ctx.closePath();
    ctx.fill();
    
    // Perfect label with background
    let midX = (startX + endX) / 2;
    let midY = (startY + endY) / 2 - 30;
    
    // Label background
    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    ctx.roundRect = ctx.roundRect || function(x, y, w, h, r) {
        this.beginPath();
        this.moveTo(x + r, y);
        this.arcTo(x + w, y, x + w, y + h, r);
        this.arcTo(x + w, y + h, x, y + h, r);
        this.arcTo(x, y + h, x, y, r);
        this.arcTo(x, y, x + w, y, r);
        this.closePath();
    };
    ctx.beginPath();
    ctx.roundRect(midX - 35, midY - 12, 70, 24, 8);
    ctx.fill();
    
    // Label border
    ctx.strokeStyle = labelColor;
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Label text
    ctx.fillStyle = labelColor;
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(label, midX, midY);
    
    ctx.restore();
}

// ========== INITIALIZE OBJECTS ==========
let man = new UltraRealisticMan(200, 650);
let umbrella = new UltraRealisticUmbrella(240, 575);
let raindrops = [];

function initializeRain() {
    raindrops = [];
    for (let i = 0; i < gameState.rainIntensity; i++) {
        raindrops.push(new PremiumRainDrop());
    }
}

// ========== BACKGROUND SYSTEM ==========
function drawUltraBackground() {
    // Dynamic sky
    let skyGradient = ctx.createLinearGradient(0, 0, 0, 700);
    if (gameState.isRunning) {
        skyGradient.addColorStop(0, '#606d75');
        skyGradient.addColorStop(0.3, '#78909c');
        skyGradient.addColorStop(1, '#90a4ae');
    } else {
        skyGradient.addColorStop(0, '#87ceeb');
        skyGradient.addColorStop(0.3, '#98d4f0');
        skyGradient.addColorStop(1, '#a9ddf5');
    }
    
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, 1200, 700);
    
    // Dynamic clouds
    let cloudOpacity = gameState.isRunning ? 0.6 : 0.8;
    let cloudColor = gameState.isRunning ? 'rgba(96, 109, 117, ' + cloudOpacity + ')' : 'rgba(255, 255, 255, ' + cloudOpacity + ')';
    
    ctx.fillStyle = cloudColor;
    for (let i = 0; i < 8; i++) {
        let x = (i * 180) + (gameState.time * 0.15) % 1600 - 200;
        drawRealisticCloud(x, 30 + i * 12, 1 + Math.sin(gameState.time * 0.01 + i) * 0.2);
    }
    
    // Ground with depth
    let groundGradient = ctx.createLinearGradient(0, 650, 0, 700);
    groundGradient.addColorStop(0, '#2d5016');
    groundGradient.addColorStop(0.5, '#1f3a0f');
    groundGradient.addColorStop(1, '#0f1a07');
    ctx.fillStyle = groundGradient;
    ctx.fillRect(0, 650, 1200, 50);
    
    // Grass texture
    ctx.strokeStyle = '#4a7c29';
    ctx.lineWidth = 1;
    for (let i = 0; i < 100; i++) {
        let x = i * 12;
        let height = 5 + Math.random() * 8;
        ctx.beginPath();
        ctx.moveTo(x, 650);
        ctx.lineTo(x + Math.random() * 2 - 1, 650 - height);
        ctx.stroke();
    }
    
    // Road surface with texture
    let roadGradient = ctx.createLinearGradient(0, 642, 0, 654);
    roadGradient.addColorStop(0, '#555555');
    roadGradient.addColorStop(0.5, '#404040');
    roadGradient.addColorStop(1, '#2a2a2a');
    ctx.fillStyle = roadGradient;
    ctx.fillRect(0, 642, 1200, 12);
    
    // Road texture details
    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
    for (let i = 0; i < 60; i++) {
        ctx.beginPath();
        ctx.arc(Math.random() * 1200, 642 + Math.random() * 12, Math.random() * 2, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // Road center line
    ctx.strokeStyle = '#ffeb3b';
    ctx.lineWidth = 5;
    ctx.setLineDash([40, 20]);
    ctx.beginPath();
    ctx.moveTo(0, 648);
    ctx.lineTo(1200, 648);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Road edges
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, 642);
    ctx.lineTo(1200, 642);
    ctx.moveTo(0, 654);
    ctx.lineTo(1200, 654);
    ctx.stroke();
}

function drawRealisticCloud(x, y, scale) {
    ctx.save();
    ctx.scale(scale, scale);
    
    // Cloud shadow
    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
    ctx.beginPath();
    ctx.arc(x/scale + 2, y/scale + 2, 35, 0, Math.PI * 2);
    ctx.arc(x/scale + 35, y/scale + 2, 45, 0, Math.PI * 2);
    ctx.arc(x/scale + 70, y/scale + 2, 35, 0, Math.PI * 2);
    ctx.arc(x/scale + 35, y/scale - 18, 30, 0, Math.PI * 2);
    ctx.fill();
    
    // Main cloud
    ctx.fillStyle = gameState.isRunning ? 'rgba(150, 150, 150, 0.8)' : 'rgba(255, 255, 255, 0.9)';
    ctx.beginPath();
    ctx.arc(x/scale, y/scale, 35, 0, Math.PI * 2);
    ctx.arc(x/scale + 35, y/scale, 45, 0, Math.PI * 2);
    ctx.arc(x/scale + 70, y/scale, 35, 0, Math.PI * 2);
    ctx.arc(x/scale + 35, y/scale - 20, 30, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.restore();
}

// ========== PHYSICS VECTORS ==========
function drawPhysicsVectors() {
    if (!man) return;
    
    let baseX = man.x;
    let baseY = man.y - 180;
    
    if (gameState.isRunning) {
        // Rain relative to ground (diagonal green)
        drawPerfectVector(
            baseX - 140, baseY,
            baseX - 60, baseY + 160,
            '#22c55e', 'v‚Éó rain,ground', '#22c55e'
        );
        
        // Man velocity (horizontal blue)
        drawPerfectVector(
            baseX, baseY,
            baseX + 140, baseY,
            '#3b82f6', 'v‚Éó man', '#3b82f6'
        );
        
        // Rain relative to man (vertical red)
        drawPerfectVector(
            baseX + 180, baseY,
            baseX + 180, baseY + 160,
            '#ef4444', 'v‚Éó rain,man', '#ef4444'
        );
        
    } else {
        // Stationary rain vector (diagonal green)
        drawPerfectVector(
            baseX, baseY,
            baseX + 80, baseY + 160,
            '#22c55e', 'v‚Éó rain', '#22c55e'
        );
        
        // Theta angle visualization
        if (gameState.hasUmbrella && umbrella) {
            drawAngleTheta();
        }
    }
}

function drawAngleTheta() {
    ctx.save();
    
    let umbX = umbrella.x;
    let umbY = umbrella.y;
    
    // Vertical reference line
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 4;
    ctx.setLineDash([10, 5]);
    ctx.beginPath();
    ctx.moveTo(umbX, umbY);
    ctx.lineTo(umbX, umbY - 100);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Angle arc
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.arc(umbX, umbY, 50, -Math.PI/2, umbrella.angle, false);
    ctx.stroke();
    
    // Angle arrow
    let endX = umbX + 50 * Math.cos(umbrella.angle);
    let endY = umbY + 50 * Math.sin(umbrella.angle);
    ctx.fillStyle = '#f59e0b';
    ctx.beginPath();
    ctx.moveTo(endX, endY);
    ctx.lineTo(endX - 10, endY - 5);
    ctx.lineTo(endX - 10, endY + 5);
    ctx.closePath();
    ctx.fill();
    
    // Theta label with perfect styling
    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    ctx.beginPath();
    ctx.arc(umbX + 80, umbY - 20, 20, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.strokeStyle = '#f59e0b';
    ctx.lineWidth = 3;
    ctx.stroke();
    
    ctx.fillStyle = '#f59e0b';
    ctx.font = 'bold 24px Times New Roman, serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('Œ∏', umbX + 80, umbY - 20);
    
    ctx.restore();
}

// ========== PERFECT MATH DISPLAY ==========
function updateMathDisplay() {
    const formula = document.getElementById('formula');
    const currentPhase = document.getElementById('currentPhase');
    const explanation = document.getElementById('explanation');
    
    if (gameState.isRunning) {
        currentPhase.innerHTML = 'Phase: <span style="color: #4ecdc4; font-weight: bold;">Man Running</span> üèÉ‚Äç‚ôÇÔ∏è';
        
        formula.innerHTML = `
            <span class="vector-notation" style="color: #ef4444; font-size: 28px;">v‚Éó<sub>rain,man</sub></span>
            <span style="color: #fff; font-size: 28px;"> = </span>
            <span class="vector-notation" style="color: #22c55e; font-size: 28px;">v‚Éó<sub>rain,ground</sub></span>
            <span style="color: #fff; font-size: 28px;"> ‚àí </span>
            <span class="vector-notation" style="color: #3b82f6; font-size: 28px;">v‚Éó<sub>man</sub></span>
        `;
        
        explanation.innerHTML = 'üîç <strong>Key Insight:</strong> Rain appears <em>vertical</em> relative to the running man due to relative motion!';
        document.getElementById('mathDisplay').style.borderColor = '#ef4444';
        document.getElementById('mathDisplay').style.boxShadow = '0 8px 32px rgba(239, 68, 68, 0.3)';
        
    } else {
        currentPhase.innerHTML = 'Phase: <span style="color: #f59e0b; font-weight: bold;">Man with Umbrella</span> ‚òÇÔ∏è';
        
        formula.innerHTML = `
            <span class="vector-notation" style="color: #22c55e; font-size: 28px;">v‚Éó<sub>rain,rel</sub></span>
            <span style="color: #fff; font-size: 28px;"> = </span>
            <span class="vector-notation" style="color: #22c55e; font-size: 28px;">v‚Éó<sub>rain,ground</sub></span>
        `;
        
        explanation.innerHTML = 'üîç <strong>Observation:</strong> Rain hits umbrella <em>diagonally</em> from above at angle Œ∏';
        document.getElementById('mathDisplay').style.borderColor = '#22c55e';
        document.getElementById('mathDisplay').style.boxShadow = '0 8px 32px rgba(34, 197, 94, 0.3)';
    }
}

// ========== CONTROL SYSTEM ==========
function startRunning() {
    if (!gameState.isRunning) {
        gameState.isRunning = true;
        umbrella.throw();
        
        const playBtn = document.getElementById('playBtn');
        playBtn.classList.add('running');
        playBtn.innerHTML = 'üèÉ RUNNING...';
        playBtn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
    }
}

function pauseAnimation() {
    gameState.isPaused = !gameState.isPaused;
    const pauseBtn = document.getElementById('pauseBtn');
    
    if (gameState.isPaused) {
        pauseBtn.innerHTML = '‚ñ∂Ô∏è Resume';
        pauseBtn.classList.add('paused');
        pauseBtn.style.background = 'linear-gradient(45deg, #f39c12, #e67e22)';
    } else {
        pauseBtn.innerHTML = '‚è∏Ô∏è Pause';
        pauseBtn.classList.remove('paused');
        pauseBtn.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a52)';
    }
}

function resetAnimation() {
    gameState.isRunning = false;
    gameState.isPaused = false;
    gameState.hasUmbrella = true;
    gameState.umbrellaThrown = false;
    
    man.x = 200;
    man.runCycle = 0;
    man.armSwing = 0;
    
    umbrella.thrown = false;
    umbrella.x = 240;
    umbrella.y = 575;
    umbrella.velocity = { x: 0, y: 0 };
    umbrella.rotation = 0;
    
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    
    playBtn.classList.remove('running');
    playBtn.innerHTML = '‚ñ∂Ô∏è Start Running';
    playBtn.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a52)';
    
    pauseBtn.classList.remove('paused');
    pauseBtn.innerHTML = '‚è∏Ô∏è Pause';
    pauseBtn.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a52)';
}

// ========== MAIN ANIMATION LOOP ==========
function animate() {
    if (!gameState.isPaused) {
        // High-performance clear
        ctx.clearRect(0, 0, 1200, 700);
        
        // Draw all elements
        drawUltraBackground();
        
        // Update and draw rain
        raindrops.forEach(drop => {
            drop.update();
            drop.draw();
        });
        
        // Update man
        man.update();
        if (gameState.hasUmbrella && !umbrella.thrown) {
            umbrella.x = man.x + 40;
            umbrella.y = man.y - 75;
        }
        
        // Update umbrella
        umbrella.update();
        
        // Draw objects
        man.draw();
        if (!umbrella.thrown || umbrella.y < 650) {
            umbrella.draw();
        }
        
        // Draw physics vectors
        drawPhysicsVectors();
        
        // Update UI
        updateMathDisplay();
        
        gameState.time++;
    }
    
    requestAnimationFrame(animate);
}

// ========== EVENT LISTENERS ==========
document.getElementById('playBtn').addEventListener('click', startRunning);
document.getElementById('pauseBtn').addEventListener('click', pauseAnimation);
document.getElementById('resetBtn').addEventListener('click', resetAnimation);

document.getElementById('rainSlider').addEventListener('input', (e) => {
    const newIntensity = parseInt(e.target.value);
    document.getElementById('rainValue').textContent = newIntensity;
    
    const difference = newIntensity - gameState.rainIntensity;
    if (difference > 0) {
        for (let i = 0; i < difference; i++) {
            raindrops.push(new PremiumRainDrop());
        }
    } else if (difference < 0) {
        raindrops.splice(0, Math.abs(difference));
    }
    
    gameState.rainIntensity = newIntensity;
});

document.getElementById('speedSlider').addEventListener('input', (e) => {
    gameState.manSpeed = parseFloat(e.target.value);
    document.getElementById('speedValue').textContent = gameState.manSpeed.toFixed(1);
});

canvas.addEventListener('click', startRunning);

// ========== SMOOTH INITIALIZATION ==========
function initializeApp() {
    console.log('üöÄ Initializing Ultra-Realistic Physics Animation...');
    
    // Initialize rain
    initializeRain();
    
    // Hide loading screen
    const loadingScreen = document.getElementById('loadingScreen');
    setTimeout(() => {
        loadingScreen.style.opacity = '0';
        setTimeout(() => {
            loadingScreen.style.display = 'none';
            gameState.loaded = true;
        }, 500);
    }, 1500);
    
    // Start animation
    animate();
    
    console.log('‚ú® ULTIMATE Animation Ready!');
    console.log('üéÆ Click canvas or controls to interact!');
    console.log('üåßÔ∏è Perfect physics with ultra-realistic graphics!');
}

// ========== START THE ULTIMATE EXPERIENCE ==========
window.addEventListener('load', () => {
    setTimeout(initializeApp, 100);
});

</script>

</body>
</html>
